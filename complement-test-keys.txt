2025/10/27 20:10:46 config: &{BaseImageURI:complement-ferretcannon:latest DebugLoggingEnabled:false AlwaysPrintServerLogs:false EnvVarsPropagatePrefix: SpawnHSTimeout:3m0s KeepBlueprints:[] HostMounts:[] BaseImageURIs:map[] PackageNamespace:fed CACertificate:0xc000c62008 CAPrivateKey:0xc000c28070 BestEffort:false HostnameRunningComplement:host.docker.internal EnableDirtyRuns:false HSPortBindingIP:127.0.0.1 PostTestScript:}
=== RUN   TestInboundFederationKeys
    federation_keys_test.go:29: Deploy times: 17.887474509s blueprints, 5.5938516s containers
    federation_keys_test.go:38: [31mmust.NotError: failed to GET /keys -> Get "https://127.0.0.1:32910/_matrix/key/v2/server": http: server gave HTTP response to HTTPS client[39m
2025/10/27 20:11:11 ============================================


2025/10/27 20:11:11 8f2946cbc82c5b7225f77baf5ebd9565ee11bc5458a29e1eb6841d3f44ac964c : Server logs:
+ export 'SERVER_NAME=hs1'
+ envsubst
+ echo '🚀 Starting FERRETCANNON Matrix Server for Complement testing'
+ echo 'Server Name: hs1'
+ echo 'Port: 8008'
+ echo 
+ echo '=== Config file contents ==='
+ cat /app/config.yml
🚀 Starting FERRETCANNON Matrix Server for Complement testing
Server Name: hs1
Port: 8008

=== Config file contents ===
server:
  host: 0.0.0.0
  port: 8008
  maxRequestSize: 10485760
  corsAllowedOrigins:
    - "*"

database:
  url: jdbc:sqlite:/data/ferretcannon.db
  driver: org.sqlite.JDBC
  maxConnections: 10
  connectionTimeout: 30000

federation:
  serverName: hs1
  federationPort: 8448
  enableFederation: true
  allowedServers:
    - "*"
  keyValidityPeriod: 86400000

security:
  jwtSecret: complement-test-secret-key-do-not-use-in-production
  tokenExpirationHours: 24
  bcryptRounds: 4
  rateLimitRequests: 300
  rateLimitPeriodMinutes: 1
  enableRateLimiting: false
  disableRegistration: false

media:
  maxUploadSize: 10485760
  maxImageSize: 10485760
  maxAvatarSize: 1048576
  maxThumbnailSize: 1048576

development:
  enableDebugLogging: true
  isDebug: true

=== Checking application files ===
+ echo 
+ echo '=== Checking application files ==='
+ ls -la /app/bin/
total 36
drwxr-xr-x    2 root     root          4096 Oct 27 19:55 .
drwxr-xr-x    1 root     root          4096 Oct 27 20:10 ..
-rwxr-xr-x    1 root     root         12379 Oct 27 19:55 FERRETCANNON
-rwxr-xr-x    1 root     root          6692 Oct 27 19:55 FERRETCANNON.bat

+ echo 
+ '[' -f /app/bin/FERRETCANNON ]
+ echo 'FERRETCANNON binary exists'
+ file /app/bin/FERRETCANNON
FERRETCANNON binary exists
/app/bin/FERRETCANNON: POSIX shell script, Unicode text, UTF-8 text executable, with very long lines (3744)
+ head -5 /app/bin/FERRETCANNON
#!/bin/sh

#
# Copyright © 2015 the original authors.
#
+ echo 

+ ls -la /app/lib/
+ head -20
total 51764
drwxr-xr-x    2 root     root          4096 Oct 27 19:55 .
drwxr-xr-x    1 root     root          4096 Oct 27 20:10 ..
-rw-r--r--    1 root     root       1831175 Oct 27 19:55 FERRETCANNON-1.0-SNAPSHOT.jar
-rw-r--r--    1 root     root          5557 Oct 27 19:55 alpn-api-1.1.3.v20160715.jar
-rw-r--r--    1 root     root         29371 Oct 27 19:55 annotations-23.0.0.jar
-rw-r--r--    1 root     root       1109571 Oct 27 19:55 bcpkix-jdk18on-1.76.jar
-rw-r--r--    1 root     root       8361943 Oct 27 19:55 bcprov-jdk18on-1.76.jar
-rw-r--r--    1 root     root         40575 Oct 27 19:55 bcrypt-0.10.2.jar
-rw-r--r--    1 root     root        676737 Oct 27 19:55 bcutil-jdk18on-1.76.jar
-rw-r--r--    1 root     root         80919 Oct 27 19:55 bytes-1.5.0.jar
-rw-r--r--    1 root     root        223979 Oct 27 19:55 checker-qual-3.33.0.jar
-rw-r--r--    1 root     root        296029 Oct 27 19:55 config-1.4.3.jar
-rw-r--r--    1 root     root        533089 Oct 27 19:55 dnsjava-3.5.2.jar
-rw-r--r--    1 root     root         63292 Oct 27 19:55 eddsa-0.3.0.jar
-rw-r--r--    1 root     root         16017 Oct 27 19:55 error_prone_annotations-2.18.0.jar
-rw-r--r--    1 root     root       1100015 Oct 27 19:55 exposed-core-0.41.1.jar
-rw-r--r--    1 root     root        185912 Oct 27 19:55 exposed-dao-0.41.1.jar
-rw-r--r--    1 root     root         59218 Oct 27 19:55 exposed-jdbc-0.41.1.jar
-rw-r--r--    1 root     root          4617 Oct 27 19:55 failureaccess-1.0.1.jar

=== Java version ===
+ echo 
+ echo '=== Java version ==='
+ java -version
openjdk version "17-ea" 2021-09-14
OpenJDK Runtime Environment (build 17-ea+14)
OpenJDK 64-Bit Server VM (build 17-ea+14, mixed mode, sharing)
+ echo 
+ echo '=== Starting server binary with sh ==='
+ cd /app
+ sh /app/bin/FERRETCANNON

=== Starting server binary with sh ===
FERRETCANNON MAIN STARTED - NEW CODE VERSION
2025-10-27 20:11:05.148 [main] INFO  Main - 🚀 Starting FERRETCANNON Matrix Server...
Loading configuration from: /app/config.yml
2025-10-27 20:11:05.599 [main] INFO  Main - ✅ Configuration loaded successfully from: ServerConfig
enableDebugLogging: true
2025-10-27 20:11:05.600 [main] INFO  Main - 🔧 Debug logging enabled for Exposed ORM and application components
2025-10-27 20:11:05.600 [main] INFO  Main - 🔧 Root logging level set to DEBUG
2025-10-27 20:11:05.600 [main] DEBUG Main - Connecting to database...
2025-10-27 20:11:05.610 [main] INFO  Main - ✅ Database connected successfully
2025-10-27 20:11:05.615 [main] DEBUG Main - Creating database schema...
2025-10-27 20:11:05.731 [main] INFO  Main - ✅ Database schema created/verified
2025-10-27 20:11:05.731 [main] DEBUG Main - Checking for test user creation...
2025-10-27 20:11:05.742 [main] DEBUG Exposed - SELECT COUNT(*) FROM users WHERE users.username = 'testuser'
2025-10-27 20:11:05.743 [main] DEBUG Main - Test user already exists
2025-10-27 20:11:05.743 [main] DEBUG Main - Creating fresh access token for test user...
2025-10-27 20:11:05.746 [main] DEBUG Exposed - DELETE FROM access_tokens WHERE access_tokens.user_id = '@testuser:hs1'
2025-10-27 20:11:05.757 [main] DEBUG Exposed - INSERT INTO access_tokens (created_at, device_id, expires_at, ip_address, last_used, token, user_agent, user_id) VALUES (1761595865751, 'test_device_1761595865744', NULL, '127.0.0.1', 1761595865751, '-OEHH7rOoGfZb53ynoHIE97Bs8ZQt1Fkyj-1RTdPJps', 'FERRETCANNON-TestClient/1.0', '@testuser:hs1')
2025-10-27 20:11:05.762 [main] DEBUG Exposed - SELECT devices.user_id, devices.device_id, devices.display_name, devices.last_seen, devices.ip_address, devices.user_agent, devices.device_type, devices.os, devices.browser, devices.browser_version, devices.created_at, devices.last_login_at, devices.ed25519_key, devices.curve25519_key, devices.ed25519_key_id, devices.curve25519_key_id FROM devices WHERE (devices.user_id = '@testuser:hs1') AND (devices.device_id = 'test_device_1761595865744')
2025-10-27 20:11:05.785 [main] DEBUG utils.ServerNameResolver - Config file content length: 759
2025-10-27 20:11:05.786 [main] DEBUG utils.ServerNameResolver - Config file content preview: server:
  host: 0.0.0.0
  port: 8008
  maxRequestSize: 10485760
  corsAllowedOrigins:
    - "*"

database:
  url: jdbc:sqlite:/data/ferretcannon.db
  driver: org.sqlite.JDBC
  maxConnections: 10
  connectionTimeout: 30000

federation:
  serverName: hs1
  federationPort: 8448
  enableFederation: true
  allowedServers:
    - "*"
  keyValidityPeriod: 86400000

security:
  jwtSecret: complement-test-secret-key-do-not-use-in-production
  tokenExpirationHours: 24
  bcryptRounds: 4
  rateLimitRequests:
Using hostname as server name: 8f2946cbc82c
2025-10-27 20:11:05.791 [main] DEBUG utils.ServerKeys - Keys not initialized, loading/generating...
2025-10-27 20:11:05.791 [main] DEBUG utils.ServerKeys - Loading or generating Ed25519 key pair for server: 8f2946cbc82c
2025-10-27 20:11:05.793 [main] DEBUG Exposed - SELECT server_keys."server_name", server_keys.key_id, server_keys.public_key, server_keys.private_key, server_keys.key_valid_until_ts, server_keys.ts_added_ts, server_keys.ts_valid_until_ts FROM server_keys WHERE server_keys."server_name" = '8f2946cbc82c' ORDER BY server_keys.ts_added_ts DESC LIMIT 1
2025-10-27 20:11:05.793 [main] INFO  utils.ServerKeys - 🔑 No existing key found - generating new Ed25519 key pair
2025-10-27 20:11:05.793 [main] DEBUG utils.ServerKeys - Generating Ed25519 key pair...
2025-10-27 20:11:05.796 [main] INFO  utils.ServerKeys - ✅ Generated server key pair with ID: ed25519:YOLO420-1761595865
2025-10-27 20:11:05.796 [main] DEBUG utils.ServerKeys - Public key (first 32 chars): ysxmU85uTjab6kRf9tY0Wl-4ekynveOw...
2025-10-27 20:11:05.797 [main] INFO  utils.ServerKeys - 💾 About to insert key into database: server=8f2946cbc82c, keyId=ed25519:YOLO420-1761595865
2025-10-27 20:11:05.805 [main] DEBUG Exposed - INSERT INTO server_keys (server_name, key_id, public_key, private_key, key_valid_until_ts, ts_added_ts, ts_valid_until_ts)
VALUES ('8f2946cbc82c', 'ed25519:YOLO420-1761595865', 'ysxmU85uTjab6kRf9tY0Wl-4ekynveOwLx-WXo5kyn8', 'XawSh0xhkCcUHcR6VbajM92eQODOZGWQ79sLE66B7NU=', 1793131865796, 1761595865796, 1793131865796)
2025-10-27 20:11:05.806 [main] INFO  utils.ServerKeys - 🔒 Raw SQL INSERT executed successfully
2025-10-27 20:11:05.806 [main] DEBUG Exposed - SELECT COUNT(*) FROM server_keys WHERE (server_keys."server_name" = '8f2946cbc82c') AND (server_keys.key_id = 'ed25519:YOLO420-1761595865')
2025-10-27 20:11:05.806 [main] INFO  utils.ServerKeys - ✅ Verification: Found 1 keys with our serverName+keyId in database
2025-10-27 20:11:05.807 [main] INFO  utils.ServerKeys - 🔒 Stored server key in database with validity until: 1793131865796
2025-10-27 20:11:05.807 [main] INFO  utils.ServerKeys - === DEBUG: Stored Keys in Database ===
2025-10-27 20:11:05.807 [main] DEBUG Exposed - SELECT server_keys."server_name", server_keys.key_id, server_keys.public_key, server_keys.private_key, server_keys.key_valid_until_ts, server_keys.ts_added_ts, server_keys.ts_valid_until_ts FROM server_keys
2025-10-27 20:11:05.808 [main] INFO  utils.ServerKeys - Found 2 keys in database:
2025-10-27 20:11:05.809 [main] INFO  utils.ServerKeys -   Server: ea24b8bc5b95, Key ID: ed25519:YOLO420-1761595849
2025-10-27 20:11:05.809 [main] INFO  utils.ServerKeys -   Public Key: V_AUjGMMi1KMJ_jhpLMTJuTrCaJS9V2BvMyIzIbtPes...
2025-10-27 20:11:05.809 [main] INFO  utils.ServerKeys -   Valid Until: 1793131849080
2025-10-27 20:11:05.809 [main] INFO  utils.ServerKeys -   Server: 8f2946cbc82c, Key ID: ed25519:YOLO420-1761595865
2025-10-27 20:11:05.809 [main] INFO  utils.ServerKeys -   Public Key: ysxmU85uTjab6kRf9tY0Wl-4ekynveOwLx-WXo5kyn8...
2025-10-27 20:11:05.809 [main] INFO  utils.ServerKeys -   Valid Until: 1793131865796
2025-10-27 20:11:05.811 [main] DEBUG Exposed - INSERT INTO devices (browser, browser_version, created_at, curve25519_key, curve25519_key_id, device_id, device_type, display_name, ed25519_key, ed25519_key_id, ip_address, last_login_at, last_seen, os, user_agent, user_id) VALUES ('Unknown', 'Unknown', 1761595865811, 'ysxmU85uTjab6kRf9tY0Wl-4ekynveOwLx-WXo5kyn8', 'ed25519:YOLO420-1761595865', 'test_device_1761595865744', 'unknown', NULL, 'ysxmU85uTjab6kRf9tY0Wl-4ekynveOwLx-WXo5kyn8', 'ed25519:YOLO420-1761595865', '127.0.0.1', 1761595865811, 1761595865811, 'Unknown', 'FERRETCANNON-TestClient/1.0', '@testuser:hs1')
2025-10-27 20:11:05.812 [main] INFO  Main - ✅ Created fresh access token for test user
2025-10-27 20:11:05.812 [main] INFO  Main - 🔑 Access Token: -OEHH7rOoGfZb53ynoHIE97Bs8ZQt1Fkyj-1RTdPJps
2025-10-27 20:11:05.812 [main] INFO  Main - 👤 User ID: @testuser:hs1
2025-10-27 20:11:05.812 [main] INFO  Main - 📱 Device ID: test_device_1761595865744
2025-10-27 20:11:05.812 [main] INFO  Main - 📋 Test endpoints with:
2025-10-27 20:11:05.812 [main] INFO  Main -    curl -H "Authorization: Bearer -OEHH7rOoGfZb53ynoHIE97Bs8ZQt1Fkyj-1RTdPJps" http://localhost:8008/_matrix/client/v3/capabilities
2025-10-27 20:11:05.829 [main] DEBUG Main - Initializing media storage...
MediaStorage initialized with maxFileSize: 10485760 bytes, maxThumbnailSize: 800 px
2025-10-27 20:11:05.832 [main] INFO  Main - ✅ Media storage initialized with max upload size: 10485760 bytes
2025-10-27 20:11:05.832 [main] DEBUG Main - Initializing server name resolver...
2025-10-27 20:11:05.832 [main] INFO  Main - ✅ Server name resolver initialized
2025-10-27 20:11:05.832 [main] DEBUG Main - Creating embedded client server instance...
2025-10-27 20:11:05.863 [main] DEBUG Main - Creating embedded federation server instance...
2025-10-27 20:11:05.864 [main] DEBUG Main - Starting client server...
2025-10-27 20:11:05.864 [main] INFO  ktor.application - Autoreload is disabled because the development mode is off.
2025-10-27 20:11:05.868 [main] DEBUG Main - Configuring client server plugins and routes...
2025-10-27 20:11:05.879 [main] DEBUG Main - ✅ CORS plugin installed
2025-10-27 20:11:05.889 [main] DEBUG Main - ✅ ContentNegotiation plugin installed
2025-10-27 20:11:05.892 [main] DEBUG Main - ✅ WebSockets plugin installed
2025-10-27 20:11:05.893 [main] DEBUG Main - ✅ Authentication plugin installed
2025-10-27 20:11:05.893 [main] DEBUG Main - Setting up client routes...
CrossSigningRoutes - crossSigningRoutes() function called
2025-10-27 20:11:05.952 [main] DEBUG f.geraghty.ed.yolo.ferretcannon - CrossSigningRoutes - crossSigningRoutes() function called
MediaStorage initialized with maxFileSize: 10485760 bytes, maxThumbnailSize: 320 px
2025-10-27 20:11:05.959 [main] INFO  Main - ✅ Client routes configured
2025-10-27 20:11:05.959 [main] DEBUG Main - Setting up well-known routes...
2025-10-27 20:11:05.963 [main] INFO  Main - ✅ Well-known routes configured
2025-10-27 20:11:05.963 [main] DEBUG Main - Setting up test endpoints for compliance testing...
2025-10-27 20:11:05.964 [main] INFO  Main - ✅ Test endpoints configured
2025-10-27 20:11:05.965 [main] DEBUG Main - Setting up basic routes...
2025-10-27 20:11:05.967 [main] DEBUG Main - ✅ Basic routes configured
2025-10-27 20:11:05.967 [main] INFO  Main - ✅ Client server configuration complete
2025-10-27 20:11:05.967 [main] INFO  ktor.application - Application started in 0.121 seconds.
2025-10-27 20:11:06.078 [main] INFO  Main - 🎉 Client server started successfully!
2025-10-27 20:11:06.078 [DefaultDispatcher-worker-1] INFO  ktor.application - Responding at http://0.0.0.0:8008
2025-10-27 20:11:06.078 [main] INFO  Main - 🌐 Client server is running on 0.0.0.0:8008
2025-10-27 20:11:06.078 [main] DEBUG Main - Starting federation server...
2025-10-27 20:11:06.078 [main] INFO  ktor.application - Autoreload is disabled because the development mode is off.
2025-10-27 20:11:06.079 [main] DEBUG Main - Configuring federation server plugins and routes...
2025-10-27 20:11:06.079 [main] WARN  Main - ⚠️  Federation server running on HTTP - need to configure HTTPS for production
2025-10-27 20:11:06.079 [main] DEBUG Main - ✅ ContentNegotiation plugin installed
2025-10-27 20:11:06.079 [main] DEBUG Main - ✅ Authentication plugin installed
2025-10-27 20:11:06.079 [main] DEBUG Main - Setting up federation routes...
2025-10-27 20:11:06.100 [main] INFO  Main - ✅ Federation routes configured
2025-10-27 20:11:06.101 [main] DEBUG Main - Setting up key routes...
2025-10-27 20:11:06.103 [main] INFO  Main - ✅ Key routes configured
2025-10-27 20:11:06.103 [main] INFO  Main - ✅ Federation server configuration complete
2025-10-27 20:11:06.103 [main] INFO  ktor.application - Application started in 0.239 seconds.
2025-10-27 20:11:06.131 [DefaultDispatcher-worker-1] INFO  ktor.application - Responding at http://0.0.0.0:8448
2025-10-27 20:11:06.131 [main] INFO  Main - 🎉 Federation server started successfully!
2025-10-27 20:11:06.132 [main] INFO  Main - 🌐 Federation server is running on 0.0.0.0:8448
2025-10-27 20:11:06.132 [main] INFO  Main - 📋 Available endpoints:
2025-10-27 20:11:06.132 [main] INFO  Main -    - Client API: http://0.0.0.0:8008/_matrix/client/
2025-10-27 20:11:06.132 [main] INFO  Main -    - Federation API: http://0.0.0.0:8448/_matrix/federation/
2025-10-27 20:11:06.132 [main] INFO  Main -    - Key API: http://0.0.0.0:8448/_matrix/key/
2025-10-27 20:11:06.132 [main] INFO  Main -    - Well-known: http://0.0.0.0:8008/.well-known/matrix/
2025-10-27 20:11:06.132 [main] INFO  Main -    - Server Info: http://0.0.0.0:8008/_matrix/server-info
2025-10-27 20:11:06.133 [main] INFO  Main -    - WebSocket: ws://0.0.0.0:8008/ws/room/{roomId}
2025-10-27 20:11:06.133 [main] INFO  Main - 🛑 Press Ctrl+C to stop the servers
2025-10-27 20:11:09.947 [eventLoopGroupProxy-4-1] DEBUG r.client_server.client.ClientRoutes - Authentication middleware - accessToken: 'null'
2025-10-27 20:11:09.947 [eventLoopGroupProxy-4-1] DEBUG r.client_server.client.ClientRoutes - No token provided
2025-10-27 20:11:09.954 [eventLoopGroupProxy-4-1] TRACE i.k.s.p.c.ContentNegotiation - Skipping because body is already converted.
2025-10-27 20:11:09.977 [eventLoopGroupProxy-4-2] DEBUG r.client_server.client.ClientRoutes - Authentication middleware - accessToken: 'null'
2025-10-27 20:11:09.977 [eventLoopGroupProxy-4-2] DEBUG r.client_server.client.ClientRoutes - No token provided
2025-10-27 20:11:09.978 [eventLoopGroupProxy-4-2] TRACE i.k.s.p.c.ContentNegotiation - Skipping because body is already converted.
2025/10/27 20:11:11 ============== 8f2946cbc82c5b7225f77baf5ebd9565ee11bc5458a29e1eb6841d3f44ac964c : END LOGS ==============


--- FAIL: TestInboundFederationKeys (24.94s)
FAIL
FAIL	github.com/matrix-org/complement/tests	26.204s
FAIL
